# Deployments Part 1

## Kubernetes Resource Hierarchy

```
Applications > Deployment > ReplicaSet > Pods
```

- **Deployments**: Handle upgrades and rollbacks
- **ReplicaSets**: Provide self-healing and scaling (manual/auto)

## Deployment Structure

### Key Components
1. **Metadata**: Deployment identification and labels
2. **Spec**: Defines desired state (replicas, selectors, templates)
3. **Template**: Pod specification that ReplicaSet will maintain

### Important Rules
- **Pod labels** must match **ReplicaSet selector**
- **Pod labels** must match **Service selector**
- All selectors must use the same label values

## Basic Deployment YAML

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
```

## Service Creation

### Service Types
- **ClusterIP**: Accessible only within the cluster (default)
- **NodePort**: Maps node IPs to a port, accessible externally
- **LoadBalancer**: Cloud provider load balancer integration

### ClusterIP Service Example

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-deployment-svc
spec:
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```

**Apply the service:**
```bash
kubectl apply -f defone.yaml
```

## Second Deployment Example (Apache)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: apache
  labels:
    app: apache
spec:
  replicas: 4
  selector:
    matchLabels:
      app: apache
  template:
    metadata:
      labels:
        app: apache
    spec:
      containers:
      - name: nginx
        image: httpd:latest
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 200m
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 100Mi

---
apiVersion: v1
kind: Service
metadata:
  name: apache-deployment-svc
spec:
  selector:
    app: apache
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
```

## Deployment Management Commands

### View Deployments
```bash
kubectl get deployment
kubectl describe deployment
```

### View ReplicaSets
```bash
kubectl get rs
kubectl describe rs nginx-deployment-59bd8cdd74
```

### View Services
```bash
kubectl get svc
kubectl describe svc nginx-deployment-svc
```

### Test Service Connectivity
```bash
curl http://10.108.205.211
```

### View Endpoints
```bash
kubectl get ep nginx-deployment-svc
```

## Self-Healing Demonstration

**Delete a pod to trigger self-healing:**
```bash
kubectl delete pod nginx-deployment-59bd8cdd74-h5f8m
kubectl get pods -o wide
curl http://10.108.205.211  # Service should still work
```

## Scaling

### Manual Scaling

**Scale up:**
```bash
kubectl scale deployment nginx-deployment --replicas 5
```

**Scale down:**
```bash
kubectl scale deployment nginx-deployment --replicas 3
```

**Sample output after scaling to 5 replicas:**
```
bosun@manager:~/yaml$ kubectl get pods -o wide
NAME                                READY   STATUS    RESTARTS   AGE     IP               NODE      NOMINATED NODE   READINESS GATES
apache-68598479f7-67gzn             1/1     Running   0          6m7s    172.17.189.85    worker2   <none>           <none>
apache-68598479f7-957zp             1/1     Running   0          6m47s   172.17.235.148   worker1   <none>           <none>
apache-68598479f7-fkmwj             1/1     Running   0          6m7s    172.17.235.149   worker1   <none>           <none>
apache-68598479f7-zwpdp             1/1     Running   0          6m46s   172.17.189.84    worker2   <none>           <none>
nginx-deployment-59bd8cdd74-cc2c4   1/1     Running   0          5s      172.17.189.86    worker2   <none>           <none>
nginx-deployment-59bd8cdd74-cvvtc   1/1     Running   0          49m     172.17.189.81    worker2   <none>           <none>
nginx-deployment-59bd8cdd74-k29ks   1/1     Running   0          5s      172.17.235.150   worker1   <none>           <none>
nginx-deployment-59bd8cdd74-qh4hr   1/1     Running   0          6d10h   172.17.235.144   worker1   <none>           <none>
nginx-deployment-59bd8cdd74-tklsc   1/1     Running   0          6d10h   172.17.189.78    worker2   <none>           <none>
```

### Declarative Scaling

Edit the deployment YAML and change the `replicas` field, then apply:

```bash
kubectl apply -f deployment.yaml
```

## Horizontal Pod Autoscaler (HPA)

The Horizontal Pod Autoscaler automatically scales the number of pods based on CPU utilization or other metrics.

*Note: HPA configuration will be covered in Part 2* 
