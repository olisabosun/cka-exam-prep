# Install and Create Cluster using kubeadm

This guide covers installing and creating a Kubernetes cluster using kubeadm with CRI-O as the container runtime and Calico as the pod network.

## Prerequisites

### Network Configuration
- Ensure required ports are open for Kubernetes components to communicate
- Check if ports are open using tools like netcat:
  ```bash
  nc 127.0.0.1 6443 -v
  ```

### Disable Swap
Disable swap temporarily:
```bash
sudo swapoff -a
```

Make it persistent by commenting out swap entries in `/etc/fstab`:
```bash
sudo vim /etc/fstab  # Comment out swap lines
```

### Enable IPv4 Packet Forwarding
Create sysctl configuration for Kubernetes:
```bash
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
EOF

# Apply sysctl params without reboot
sudo sysctl --system
```

Verify the setting:
```bash
sysctl net.ipv4.ip_forward
```

## Container Runtime Setup (CRI-O)

### Install Packages Script
Create a script `packages.sh` with the following content:

```bash
#!/bin/bash

KUBERNETES_VERSION=v1.32
CRIO_VERSION=v1.32

echo ""
echo "\033[4mDisabling Swap Memory.\033[0m"
echo ""
sudo swapoff -a
sed -e '/swap/s/^/#/g' -i /etc/fstab
echo
echo
echo "##################################################"
echo "############# INSTALLING PACKAGES ################"
echo "##################################################"
echo
echo
apt-get update -y
apt-get install -y software-properties-common curl
curl -fsSL https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/Release.key |
    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/$KUBERNETES_VERSION/deb/ /" |
    tee /etc/apt/sources.list.d/kubernetes.list
curl -fsSL https://pkgs.k8s.io/addons:/cri-o:/stable:/$CRIO_VERSION/deb/Release.key |
    gpg --dearmor -o /etc/apt/keyrings/cri-o-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/cri-o-apt-keyring.gpg] https://pkgs.k8s.io/addons:/cri-o:/stable:/$CRIO_VERSION/deb/ /" |
    tee /etc/apt/sources.list.d/cri-o.list
apt-get update -y
apt-get install -y cri-o kubelet kubeadm kubectl cri-tools
apt-mark hold kubelet kubeadm kubectl
systemctl start crio.service
modprobe br_netfilter
sysctl -w net.ipv4.ip_forward=1
echo
echo
echo "##################################################"
echo "############# PACKAGES INSTALLED  ################"
echo "##################################################"
echo
echo
```

Run the script on all nodes (manager and workers):
```bash
sudo sh packages.sh
```

## Control Plane (Manager Node) Setup

### Pull Required Images
```bash
sudo kubeadm config images pull
```

### Initialize the Control Plane
Choose one of the following initialization commands:

**Basic initialization:**
```bash
sudo kubeadm init --apiserver-advertise-address 192.168.49.133
```

**With pod network CIDR:**
```bash
sudo kubeadm init --apiserver-advertise-address 192.168.49.133 --pod-network-cidr 172.17.0.0/16
```

**With specific IP (example):**
```bash
sudo kubeadm init --apiserver-advertise-address 10.0.0.100 --pod-network-cidr 172.17.0.0/16
```

### Configure kubectl Access
After successful initialization, run the following as a regular user:
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

Or as root user:
```bash
export KUBECONFIG=/etc/kubernetes/admin.conf
```

## Pod Network Setup (Calico)

### Install Calico
Download and apply the Calico manifest:
```bash
kubectl apply -f https://docs.tigera.io/calico/latest/manifests/calico.yaml
```

### Verify Installation
Check nodes and pods:
```bash
kubectl get nodes
kubectl -n kube-system get pods
```

## Worker Node Setup

### Copy Installation Script to Worker
From the manager node:
```bash
scp packages.sh worker01@192.168.49.134:
```

### Install Packages on Worker
On the worker node:
```bash
sudo sh packages.sh
```

### Generate Join Token
On the manager node:
```bash
kubeadm token create --print-join-command
```

### Join Worker to Cluster
Copy the join command output and run it on the worker node with sudo:
```bash
sudo kubeadm join 192.168.49.133:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
```

**Example:**
```bash
sudo kubeadm join 192.168.49.133:6443 --token 5d32i5.9k4o0casa0ownrj8 --discovery-token-ca-cert-hash sha256:86c9722e1e60ccb428e65cc95f9c076042959cb07ee06a14dce4cc364d74f639
```

### Troubleshooting: Conntrack Errors
If you encounter conntrack errors, install additional dependencies:
```bash
sudo apt update
sudo apt install -y \
    conntrack \
    socat \
    ebtables \
    ethtool \
    ipvsadm \
    iptables
```

## Validation

### Check Cluster Status
On the manager node:
```bash
kubectl get nodes
kubectl -n kube-system get pods
```

### Check Container Runtime
```bash
sudo crictl images
```

## Notes

- Container runtime network, underlay, and overlay (pod) network run in the Kubernetes cluster
- `--pod-network-cidr` and `--apiserver-advertise-address` are optional but recommended
- Calico is used as the pod network in this setup
- Ensure all nodes can communicate on the required ports

