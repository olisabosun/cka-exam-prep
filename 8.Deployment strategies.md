# Kubernetes Deployment Strategies

This document covers different deployment strategies in Kubernetes and their practical implementation with YAML examples.

## Deployment Strategies Overview

### 1. Recreate Strategy
- **Best for**: Development environments
- **Behavior**: Terminates all existing pods before creating new ones
- **Pros**: Simple, ensures clean state
- **Cons**: Causes downtime during deployment

### 2. Rolling Update (Ramped) Strategy
- **Default strategy** in Kubernetes
- **Behavior**: Gradually replaces old pods with new ones
- **Pros**: Zero downtime, controlled rollout
- **Cons**: Slower deployment, requires careful resource planning

### 3. Blue-Green Deployment
- **Best for**: Avoiding API versioning issues
- **Behavior**: Creates a completely separate environment for new version
- **Pros**: Instant rollback, zero downtime
- **Cons**: Requires double resources during transition

### 4. Canary Deployment
- **Behavior**: Routes a small percentage of traffic to new version
- **Pros**: Risk mitigation, gradual rollout
- **Cons**: Complex routing logic required

## Rolling Update Deployment Example

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-deploy
  annotations:
    kubernetes.io/change-cause: "changing version to new"  # Tracks deployment changes for rollback
spec:
  revisionHistoryLimit: 5  # Keep 5 old ReplicaSets for rollback
  replicas: 10  # Desired number of pod replicas
  selector:
     matchLabels:
        app: hello-world  # Labels to match pods managed by this deployment
  minReadySeconds: 10  # Minimum time pod must be ready before considering rollout successful
  strategy:
     type: RollingUpdate  # Deployment strategy type
     rollingUpdate:
        maxUnavailable: 1  # Max pods that can be unavailable during update (absolute number)
        maxSurge: 1  # Max extra pods that can be created during update (absolute number)
  template:
    metadata:
      labels:
        app: hello-world  # Labels for pods created from this template
    spec:
      containers:
      - name: hello-pod
        image: lovelearnlinux/webserver:v1
        ports:
        - containerPort: 80  # Port the container exposes
        resources:
          limits:
            cpu: 100m  # CPU limit per container
            memory: 128Mi  # Memory limit per container
          requests:
            cpu: 50m  # CPU request per container
            memory: 100Mi  # Memory request per container
        readinessProbe:
          exec:
            command:
            - cat
            - /var/www/html/index.html  # Command to check if pod is ready to serve traffic
          initialDelaySeconds: 10  # Wait 10s after container starts before first probe
          periodSeconds: 10  # Check every 10 seconds
          timeoutSeconds: 4  # Timeout after 4 seconds
          failureThreshold: 2  # Mark pod unready after 2 consecutive failures
          successThreshold: 1  # Mark pod ready after 1 successful check
        livenessProbe:
          exec:
            command:
            - cat
            - /var/www/html/index.html  # Command to check if pod is alive
          initialDelaySeconds: 10  # Wait 10s after container starts before first probe
          periodSeconds: 10  # Check every 10 seconds
          timeoutSeconds: 4  # Timeout after 4 seconds
          failureThreshold: 6  # Restart container after 6 consecutive failures
          successThreshold: 1  # Mark pod alive after 1 successful check
```

## Service for Rolling Update Deployment

```yaml
apiVersion: v1
kind: Service
metadata:
  name: hello-deploy-svc
spec:
  selector:
    app: hello-world  # Routes traffic to pods with this label
  ports:
    - protocol: TCP
      port: 80  # Service port
      targetPort: 80  # Container port to forward traffic to
  type: ClusterIP  # Default service type - internal cluster access only
```

## Deployment Rollout Commands

### Update Image and Add Annotation
```bash
# Update deployment image with annotation for tracking
kubectl set image deploy/hello-deploy hello-pod=lovelearnlinux/webserver:v2 --annotation=update image from v1 to v2
```

### Add/Update Annotation
```bash
# Add change-cause annotation to track deployment changes
kubectl annotate deployments.apps hello-deploy kubernetes.io/change-cause="image changed to nginx:latest"
```

### Check Rollout History
```bash
# View deployment rollout history
kubectl rollout history deployment hello-deploy

# View specific revision details
kubectl rollout history deployment hello-deploy --revision 5
```

## Blue-Green Deployment Example

In blue-green deployment, you create a completely separate deployment with different labels and update the service selector to route traffic to the new version.

### Blue Deployment (Original Version)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-deploy-v1  # Original deployment
  annotations:
    kubernetes.io/change-cause: "original version"
spec:
  revisionHistoryLimit: 5
  replicas: 10
  selector:
     matchLabels:
        app: hello-world-v1  # Unique label for v1
  minReadySeconds: 10
  template:
    metadata:
      labels:
        app: hello-world-v1
    spec:
      containers:
      - name: hello-pod
        image: nginx:latest
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 100Mi
```

### Green Deployment (New Version)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-deploy-v2  # New deployment
  annotations:
    kubernetes.io/change-cause: "version 2 feb 2026"
spec:
  revisionHistoryLimit: 5
  replicas: 10
  selector:
     matchLabels:
        app: hello-world-v2  # Unique label for v2
  minReadySeconds: 10
  template:
    metadata:
      labels:
        app: hello-world-v2
    spec:
      containers:
      - name: hello-pod
        image: nginx:latest
        ports:
        - containerPort: 80
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 100Mi
```

### Service for Blue-Green Deployment

```yaml
apiVersion: v1
kind: Service
metadata:
  name: hello-deploy-svc
spec:
  selector:
    app: hello-world-v1  # Initially routes to v1 (blue)
    # Change to app: hello-world-v2 to switch to v2 (green)
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: ClusterIP
```

## Rollout Management Commands

### Rollout Status
```bash
kubectl rollout status deployment/hello-deploy
```

### Rollout Pause/Resume
```bash
kubectl rollout pause deployment/hello-deploy
kubectl rollout resume deployment/hello-deploy
```

### Rollout Restart
```bash
kubectl rollout restart deployment/hello-deploy
```

### Rollout Undo
```bash
# Rollback to previous version
kubectl rollout undo deployment/hello-deploy

# Rollback to specific revision
kubectl rollout undo deployment/hello-deploy --to-revision=3
```
